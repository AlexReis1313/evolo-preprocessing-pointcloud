# ROS2 Humble Lidar Point Cloud Pre-process node
This node uses an altered version of the pointcloud_to_laserscan package.

# Build and Run

    git clone https://github.com/AlexReis1313/evolo-preprocessing-pointcloud.git
    cd /evolo-preprocessing-pointcloud/
    colcon build
    source the workspace
    ros2 launch pointcloud_to_laserscan pointcloud_to_laserscan_launch_evolo.py 


For alternative vehicle parameters, use one of the following options:

    ros2 launch pointcloud_to_laserscan pointcloud_to_laserscan_launch_boat.py 
    ros2 launch pointcloud_to_laserscan pointcloud_to_laserscan_launch_sim.py 



# ROS 2 pointcloud_to_laserscan package
This is a ROS 2 package that provides components to convert `sensor_msgs/msg/PointCloud2` messages to `sensor_msgs/msg/LaserScan` messages and back.
It provides the base methods for this package. https://github.com/ros-perception/pointcloud_to_laserscan 


# pointcloud <-> laserscan converter with pre-proccessing
It has the following features:
* Get the current Tf from a fixed world frame to the frame_id that publishes a PointCLoud2 message
* Publishes a frame_id from the fixed world frame that has the same x,y,z,yaw as the PointCloud2 publisher's frame_id, and null roll and pitch.
This new frame is published in sync with new Laser Scan messages. Laser Scan messages have this new frame as their frame_id.
* Converts the 3D PointCloud messages into 2D LaserScan messages. The convertion is made with several extra steps that filter the water surface and noise from the original PointCloud, in a surface maritime environment.

# Filtering Technique

In order to filter out noisy points in the PointCloud, an addaptive version of Radius Outlier Removal (ROR) is used.

To filter out reflections seen in the water, points are removed if they land in low z coordinates and have a very low intensity in the XYZI pointcloud.

In order to filter/segment out the water surface from the Point Cloud, eliminating all points below a certain height threshold makes use of the assumption that the roll and pitch estimation for the robot are correct.
When these pitch and roll estimates have an associated error, this height threshold method eliminates a lot of important sections of the PoinCloud in long-range sections.


This package exploits the fact that water/wave detection points in a PointCloud generated by a Lidar are almost only visible in a very short range from the Lidar.
This package also exploits the fact that roll and pitch angle errors do not correspond to big height errors, in low-range scenarios.
Given this, this package computes 2 LaserScans, from the original pointcloud. It then merges the 2 into a final and filtered LaserScan that is published.
The 2 computed LaserSCans are:
* Long-range LaserScan: It includes points in a big range of heights (for example: -8m to +8m), but is limited between a ´transition_range´ and a maximum range.
* Short-range LaserScan: It includes points only above a certain height threshold, up until a ´transition_range´. It also considers a minimum range (for example: 1.5m) that eliminates the points belonging to the ego-vehicle.

# Outputs

Output LaserScan:
* Merged LaserScan: Merges the 2 computed LaserScans, by only considering the minimum range measurement between the 2 for each laser beam. Topic: `scanner/scan/merged`

Output PointClouds:
* Filtered PointCloud before conversion to LaserScan - Topic: `filtered_pointcloud`
* PointCloud with same information as merged laserScan - Topic: `scanner/scan/pointcloud`

Output real-time Map:

LaserScan message that defines the range of the closest obstacle, for each angle interval (with big angle intervals in mind). This is meant to be passed as an array of ranges to a Obstacle avoidance algorithm. The data used to generate this message is the filtered and Merged LaserScan.
* Map for Obstacle avoidance algorithm: `map/radial`
* Same Map, but meant for RVIZ visualization: `map/radial/visual`


# Output visualization
* Blue: original PointCloud
* White: Merged/filtered LaserScan `scanner/scan/merged`
* Brown: Output real-time Map `map/radial/visual`

![image](https://github.com/user-attachments/assets/fd6dd3da-37b4-4103-a2f2-987a9ca6c0b6)

 



## pointcloud\_to\_laserscan::PointCloudToLaserScanNode

This ROS 2 component projects `sensor_msgs/msg/PointCloud2` messages into `sensor_msgs/msg/LaserScan` messages.

### Published Topics

* `scanner/scan/merged` (`sensor_msgs/msg/LaserScan`) - The output laser scan.
* `laser_scan_frame` frame in Tf tree - this is frame_id of scan

### Subscribed Topics

* `cloud_in` (`sensor_msgs/msg/PointCloud2`) - The input point cloud. No input will be processed if there isn't at least one subscriber to the `scan` topic.
* `tf` - Tf transform between a given fixed world frame and the frame_id of `cloud_in`
  
### Parameters - Specific to this package

* `fixed_frame` (str, default: none)
* `cloud_frame` (str, default: none) - Frame where pointcloud is being published on: `os_sensor`
* `min_height_longrange` (double, default: 2.2e-308) - The minimum height to sample in the long-range point cloud in meters.
* `max_height_longrange` (double, default: 1.8e+308) - The maximum height to sample in the long-range point cloud in meters.
* `min_height_shortrange` (double, default: 2.2e-308) - The minimum height to sample in the short-range point cloud in meters.
* `max_height_shortrange` (double, default: 1.8e+308) - The maximum height to sample in the short-range point cloud in meters.
* `range_transition` (double, default: 1.8e+308) - The range measurement from where the Short Range LaserScan stops and the Long Range LaserScan begins

### Parameters - Kept from original package

* `angle_min` (double, default: -π) - The minimum scan angle in radians.
* `angle_max` (double, default: π) - The maximum scan angle in radians.
* `angle_increment` (double, default: π/180) - Resolution of laser scan in radians per ray.
* `queue_size` (double, default: detected number of cores) - Input point cloud queue size.
* `scan_time` (double, default: 1.0/30.0) - The scan rate in seconds. Only used to populate the scan_time field of the output laser scan message.
* `range_min` (double, default: 0.0) - The minimum ranges to return in meters.
* `range_max` (double, default: 1.8e+308) - The maximum ranges to return in meters.
* `target_frame` (str, default: none) - Mandatory - Name of the frame that the LaserScan will be published from. 
* `transform_tolerance` (double, default: 0.01) - Time tolerance for transform lookups. Only used if a `target_frame` is provided.
* `use_inf` (boolean, default: true) - If disabled, report infinite range (no obstacle) as range_max + 1. Otherwise, report infinite range as +inf.
